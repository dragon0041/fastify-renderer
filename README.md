# fastify-renderer

![Build Status](https://github.com/gadget-inc/fastify-renderer/workflows/ci/badge.svg)
[![NPM version](https://img.shields.io/npm/v/fastify-renderer.svg?style=flat)](https://www.npmjs.com/package/fastify-renderer)

`fastify-renderer` renders client side JavaScript applications on the server to improve the user experience.

- It renders client side apps server side with minimal setup
- Supports optional async work ahead of time using handy server side bits like a database connection or session stored in redis
- Serves server side props to client side pages as the navigations happen client side
- Control things outside the inner application like the `<head/>` tag when server rendering


## Installation

```shell
# Using npm
npm install fastify-renderer --save
# Using yarn
yarn install fastify-renderer
```

## Registering the plugin


```js
import fastify from 'fastify'
import renderer from 'fastify-renderer'

const server = fastify()
server.register(renderer)
```

### Configuration options
You can optionally provide configuration options to the plugin:

- `renderer` - Object that provides the rendering options
  - `type` - Only value supported currently is 'react'
  - `mode` - Specifies whether we want to render in sync or streaming mode
- `vite` - Vite [InlineConfig](https://vitejs.dev/guide/api-javascript.html#inlineconfig) options
- `base` - The base path we want our renderer to use
- `layout` - The path to a layout component inside of which other routes will be rendered
- `document` - HTML template inside of which everything is rendered
- `devMode` - Boolean, when true a vite devServer is created
- `outDir` - The directory where the files generated by the Vite build will be created
- `assetsHost` - The host url from which files will be accessible to the browser
- `hooks` - Array of FastifyRendererHook 
  - `name` - Optional string value 
  - `heads` - Function that will return html tags to be appended to the document head tag
  - `tails` - Function that will return html tags to be appended to the document body tag
  - `transform` - Function that will be run to transform the root react element


## Setting up a route
To set up a route, you can do the following:
```js
  server.get('/sample-route', { render: require.resolve('./Component') }, async (_request) => {
    const props = { hello: 'world' }
    return props
  })
```
The plugin will render the component server side and return it, where as the route handler will return the props to the frontend when needed.


## How it works
- mounts a `vite` server as a fastify plugin that knows how to transform code to be run server side.
- provides renderers that use vite for react and other popular frameworks (Currently only React is supported)
- provides a convention for async ahead of time work to pass data into renderers
- provides a router convention that the server and client agree on

## Why was it created

The goal of fastify-renderer is to bring a great developer/user experience and improve the performance of frontend applications by leveraging existing technologies.

- next.js has a great developer experience but blocks the main thread when rendering react.
- next.js uses express and webpack underneath, both of which have much better performing alternatives
- next.js must be both the bundler and the server, it's hard to mount it into an existing system like fastify and play nice with all the other plugins you might want to use when doing :gasp: server side rendered :gasp: applications
- vite is awesome but also wants to be the server and keep the frontend entirely seperate from the backend
- server side rendering is hard and reinventing that wheel is no fun
- hot reloading in development is hard and reinventing that wheel is no fun
- bundling for production is hard and reinventing that wheel is no fun
- esbuild is very fast


## Roadmap
- Add support for rendering outside the main thread by using Piscina.js
- Add support for Vue and other frontend frameworks

## License

[MIT](./LICENSE)
